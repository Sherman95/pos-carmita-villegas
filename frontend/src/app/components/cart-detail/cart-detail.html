<div class="cart-container">

  <div class="cart-header">
    <div class="header-info">
      <h2>Resumen de Cuenta üßæ</h2>
      <p>Revisa los √≠tems y el cliente</p>
    </div>
    <button mat-icon-button class="close-btn" (click)="cerrar()">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <div class="cart-scroll-content">

    <div class="client-card elevation-z1">
      
      <div class="current-client">
        <div class="icon-box">
          @if (clienteLabel() === 'Consumidor Final' || clienteLabel() === '.Consumidor Final') {
            <mat-icon>person_outline</mat-icon>
          } @else {
            <mat-icon>person</mat-icon>
          }
        </div>
        <div class="meta">
          <span class="label">Cliente Asignado</span>
          <span class="value">{{ clienteLabel() }}</span>
        </div>
      </div>
      <mat-form-field appearance="outline" class="search-field">
        <mat-icon matPrefix>search</mat-icon>
        <input matInput 
               placeholder="Buscar o cambiar cliente..." 
               [ngModel]="searchText()"
               (ngModelChange)="searchText.set($event)" 
               [matAutocomplete]="auto" 
               (focus)="limpiarBusqueda($event)">

        @if (searchText() && searchText() !== 'Consumidor Final') {
          <button mat-icon-button matSuffix (click)="searchText.set(''); $event.stopPropagation()">
            <mat-icon>close</mat-icon>
          </button>
        }

        <mat-autocomplete #auto="matAutocomplete" 
                          (optionSelected)="onOptionSelected($event)"
                          panelClass="custom-autocomplete">

          @for (c of filteredClients(); track c.id) {
            <mat-option [value]="c" class="option-row">
              <div class="row-flex">

                @if (c.cedula === '9999999999999') {
                  <div class="avatar-mini"><mat-icon>person_outline</mat-icon></div>
                } @else {
                  <div class="avatar-mini text">{{ c.nombre.charAt(0).toUpperCase() }}</div>
                }

                <div class="text-col">
                  <span class="name">{{ c.nombre }}</span>
                  @if (c.cedula !== '9999999999999') {
                    <small>{{ c.cedula }}</small>
                  }
                </div>
              </div>
            </mat-option>
          }

          @if (filteredClients().length === 0 && searchText()) {
            <mat-option disabled>No se encontraron clientes</mat-option>
          }
        </mat-autocomplete>
      </mat-form-field>
    </div>

    <div class="items-list">
      @if (cartService.items().length === 0) {
        <div class="empty-state">
          <mat-icon>shopping_cart_off</mat-icon>
          <p>El carrito est√° vac√≠o</p>
        </div>
      } @else {
        @for (linea of cartService.items(); track $index) {
          <div class="cart-item">
            <button mat-icon-button color="warn" class="btn-delete" (click)="eliminar($index)">
              <mat-icon>delete_outline</mat-icon>
            </button>

            <div class="qty-badge">x{{ linea.cantidad }}</div>

            <div class="item-desc">
              <div class="name">{{ linea.item.nombre }}</div>
              <div class="unit">Unit: ${{ linea.precioVenta }}</div>
            </div>

            <div class="item-total">
              ${{ linea.subtotal | number:'1.2-2' }}
            </div>
          </div>
        }
      }
    </div>

  </div>

  <div class="cart-footer-panel">
    <div class="totals-block">
      <div class="row">
        <span>Subtotal</span>
        <span class="num">${{ subtotal() | number:'1.2-2' }}</span>
      </div>
      <div class="row">
        <span>IVA ({{ taxRate() * 100 | number:'1.0-0' }}%)</span>
        <span class="num">${{ taxAmount() | number:'1.2-2' }}</span>
      </div>
      <div class="divider"></div>
      <div class="row grand-total">
        <span>TOTAL A PAGAR</span>
        <span>${{ grandTotal() | number:'1.2-2' }}</span>
      </div>
    </div>

    <div class="actions-row">
      <button mat-stroked-button color="primary" (click)="cerrar()">SEGUIR AGREGANDO</button>
      <button mat-flat-button class="btn-pay" (click)="cobrar()" [disabled]="cartService.items().length === 0">
        COBRAR
        <mat-icon iconPositionEnd>payments</mat-icon>
      </button>
    </div>
  </div>

</div>