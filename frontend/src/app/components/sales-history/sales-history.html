<div class="page-container">
  
  <header class="header-section">
    <div class="header-content">
      <h1>Historial y Cierre ðŸ“…</h1>
      <p>Revisa tus ventas diarias y reimprime recibos</p>
    </div>
    
    <div class="summary-float elevation-z4">
      <span class="label">Vendido Hoy</span>
      <span class="amount">${{ totalHoy() | number:'1.2-2' }}</span>
    </div>
  </header>

  <div class="history-container">

    <div class="section-title">
      <mat-icon>manage_search</mat-icon> Recibos por Cliente
    </div>

    <mat-card class="filters-card elevation-z2">
      <div class="filters-grid">
        
        <mat-form-field appearance="outline" class="client-select">
          <mat-label>Cliente</mat-label>
          <mat-select [(ngModel)]="filterClientId" panelClass="custom-history-select">
            <mat-option [value]="''">-- Todos los clientes --</mat-option>
            <mat-option *ngFor="let c of clients()" [value]="c.id">
              <div class="row-flex">
                <div class="avatar-mini">{{ c.nombre.charAt(0).toUpperCase() }}</div>
                <div class="text-col">
                  <span class="name">{{ c.nombre }}</span>
                  <span class="cedula" *ngIf="c.cedula">{{ c.cedula }}</span>
                </div>
              </div>
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Desde</mat-label>
          <input matInput type="date" [(ngModel)]="filterFrom">
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Hasta</mat-label>
          <input matInput type="date" [(ngModel)]="filterTo">
        </mat-form-field>

        <button mat-flat-button color="primary" class="btn-search" (click)="buscarRecibosPorCliente()">
          <mat-icon>search</mat-icon> BUSCAR
        </button>
      </div>

      @if (loadingReceipts()) {
        <div class="state-msg"><mat-spinner diameter="30"></mat-spinner> Cargando...</div>
      } @else if (clientReceipts().length === 0) {
        <div class="state-msg empty">Sin recibos para este filtro.</div>
      } @else {
        <div class="receipts-list">
          @for (r of clientReceipts(); track r.receipt_id) {
            <div class="receipt-row">
              <div class="info">
                <div class="name">Venta #{{ r.sale_id }}</div>
                <div class="meta">{{ r.sale_created_at | date:'medium' }} Â· <strong>${{ r.total | number:'1.2-2' }}</strong></div>
              </div>
              <button mat-stroked-button color="primary" (click)="verReciboCliente(r)" [disabled]="openingTicketId() === r.sale_id">
                <mat-icon>print</mat-icon>
                {{ openingTicketId() === r.sale_id ? '...' : 'Ticket' }}
              </button>
            </div>
          }
        </div>
      }
    </mat-card>

    <div class="section-title mt-large">
      <mat-icon>history</mat-icon> Ventas Recientes
    </div>

   <div class="sales-list-grid">
  @if (groupedSales().length === 0) {
    <div class="state-msg empty">No hay ventas registradas.</div>
  } @else {
    
    @for (group of groupedSales(); track group.date) {
      
      <div class="date-separator">
        <span class="line"></span>
        <span class="text">{{ group.label }}</span> <span class="line"></span>
      </div>

      @for (sale of group.sales; track sale.id) {
        
        <mat-card class="sale-card elevation-z1" (click)="toggleDetalles(sale.id)">
            <div class="card-header">
              <div class="time-badge">{{ formatearHora(sale.created_at) }}</div>
              <div class="total-badge">${{ sale.total | number:'1.2-2' }}</div>
            </div>

            <div class="card-body">
              <div class="client-info">
                <span class="client-name">{{ sale.client_nombre || 'Consumidor final' }}</span>
                <span class="method">{{ sale.metodo_pago || 'Efectivo' }}</span>
              </div>
              
              <div class="actions">
                <button mat-icon-button color="primary" 
                        (click)="$event.stopPropagation(); verRecibo(sale.id)" 
                        [disabled]="openingTicketId() === sale.id"
                        matTooltip="Imprimir Ticket">
                  <mat-icon>print</mat-icon>
                </button>
              </div>
            </div>

            @if (selectedSaleId() === sale.id) {
              <div class="details-box">
                @if (loadingDetail()) {
                  <p class="loading-text">Cargando...</p>
                } @else {
                  @if ((saleDetails()[sale.id] || []).length === 0) {
                    <p class="empty-text">Sin detalles.</p>
                  } @else {
                    @for (d of saleDetails()[sale.id]; track d.id) {
                      <div class="detail-row">
                        <span class="prod">{{ d.nombre_producto }}</span>
                        <span class="qty">x{{ d.cantidad }}</span>
                        <span class="price">${{ d.subtotal | number:'1.2-2' }}</span>
                      </div>
                    }
                  }
                }
              </div>
            }
        </mat-card>

      }
    }
  }
</div>