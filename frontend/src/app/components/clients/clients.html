<div class="page-container">

  <!-- ================= HEADER ================= -->
  <header class="header-section">
    <div class="header-content">
      <h1>Clientes ðŸ‘¥</h1>
      <p>Gestiona tu base de datos</p>

      <div class="search-box">
        <mat-icon class="search-icon">search</mat-icon>

        <input
          type="text"
          placeholder="Buscar por nombre, cÃ©dula o email..."
          [ngModel]="searchTerm()"
          (ngModelChange)="setSearch($event)"
        />

        @if (searchTerm()) {
          <button mat-icon-button (click)="setSearch('')">
            <mat-icon>close</mat-icon>
          </button>
        }
      </div>

      <button mat-flat-button class="btn-add" (click)="showCreateForm()">
        <mat-icon>add</mat-icon>
        NUEVO CLIENTE
      </button>
    </div>
  </header>

  <!-- ================= LISTA ================= -->
  <div class="list-container">

    @if (loading()) {
      <div class="state-message">Cargando clientes...</div>

    } @else if (filteredClients().length === 0) {
      <div class="state-message empty">
        <mat-icon>person_off</mat-icon>
        <p>No se encontraron clientes.</p>
      </div>

    } @else {
      @for (c of filteredClients(); track c.id) {
        <div class="client-card elevation-z2" (click)="editClient(c)">

          <div class="card-content">
            <div class="avatar-circle">
              {{ c.nombre.charAt(0).toUpperCase() }}
            </div>

            <div class="text-info">
              <span class="name">{{ c.nombre }}</span>

              <span class="details">
                <mat-icon class="tiny-icon">badge</mat-icon>
                {{ c.cedula || 'S/N' }}
              </span>

              <span class="details secondary">
                <mat-icon class="tiny-icon">phone</mat-icon>
                {{ c.telefono || 'Sin cel' }} Â· {{ c.email || 'Sin email' }}
              </span>
            </div>
          </div>

          <div class="actions">
            <button
              mat-icon-button
              color="warn"
              (click)="deleteClient(c.id); $event.stopPropagation()"
            >
              <mat-icon>delete_outline</mat-icon>
            </button>
          </div>
        </div>
      }
    }
  </div>

  <!-- ================= MODAL ================= -->
  <ng-template #clientFormDialog>

    <!-- Header -->
    <div class="dialog-header-modern">
      <h2 mat-dialog-title>
        {{ selectedClientId() ? 'Editar Cliente ðŸ‘¤' : 'Nuevo Cliente âœ¨' }}
      </h2>

      <button mat-icon-button mat-dialog-close tabindex="-1" class="close-btn">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <!-- Contenido -->
    <mat-dialog-content class="modern-content">

      <p class="subtitle">InformaciÃ³n de contacto y facturaciÃ³n.</p>

      <!-- ðŸ”´ ERROR DEL BACKEND -->
      @if (formError()) {
        <div class="form-error">
          <mat-icon>error_outline</mat-icon>
          {{ formError() }}
        </div>
      }

      <div class="form-grid-2">

        <!-- NOMBRE -->
        <mat-form-field appearance="outline" class="col-span-2">
          <mat-label>Apellidos y Nombres (RazÃ³n Social)</mat-label>
          <mat-icon matPrefix>person</mat-icon>

          <input
            matInput
            [ngModel]="form().nombre"
            (ngModelChange)="updateField('nombre', $event.toUpperCase())"
            placeholder="Ej. PEREZ LOPEZ JUAN CARLOS"
            required
          />

          <mat-hint>Tal cual aparece en el RUC o CÃ©dula</mat-hint>
        </mat-form-field>

        <!-- CEDULA -->
        <mat-form-field appearance="outline">
          <mat-label>CÃ©dula / RUC</mat-label>
          <mat-icon matPrefix>badge</mat-icon>

          <input
            matInput
            [ngModel]="form().cedula"
            (ngModelChange)="updateField('cedula', $event)"
            placeholder="10 dÃ­gitos (CÃ©dula) o 13 (RUC)"
            maxlength="13"
          />
        </mat-form-field>

        <!-- TELEFONO -->
        <mat-form-field appearance="outline">
          <mat-label>TelÃ©fono</mat-label>
          <mat-icon matPrefix>phone</mat-icon>

          <input
            matInput
            [ngModel]="form().telefono"
            (ngModelChange)="updateField('telefono', $event)"
            placeholder="099..."
            type="tel"
            maxlength="10"
          />
        </mat-form-field>

        <!-- EMAIL -->
        <mat-form-field appearance="outline" class="col-span-2">
          <mat-label>Correo ElectrÃ³nico</mat-label>
          <mat-icon matPrefix>mail</mat-icon>

          <input
            matInput
            [ngModel]="form().email"
            (ngModelChange)="updateField('email', $event.toLowerCase())"
            placeholder="cliente@email.com"
          />
        </mat-form-field>

        <!-- DIRECCION -->
        <mat-form-field appearance="outline" class="col-span-2">
          <mat-label>DirecciÃ³n</mat-label>
          <mat-icon matPrefix>place</mat-icon>

          <input
            matInput
            [ngModel]="form().direccion"
            (ngModelChange)="updateField('direccion', $event.toUpperCase())"
            placeholder="CALLE PRINCIPAL Y SECUNDARIA..."
          />
        </mat-form-field>

      </div>
    </mat-dialog-content>

    <!-- Acciones -->
    <mat-dialog-actions align="end" class="modern-actions">
      <button mat-button (click)="cancelar()">Cancelar</button>

      <button
        mat-flat-button
        color="primary"
        (click)="guardar()"
        [disabled]="!form().nombre"
      >
        {{ selectedClientId() ? 'Actualizar' : 'Guardar Cliente' }}
      </button>
    </mat-dialog-actions>

  </ng-template>
</div>
