<div class="page-container fade-in">

  <header class="header-section">
    <div class="header-content">
      <h1>Clientes </h1>
      <p>Gestiona tu base de datos de clientes</p>

      <div class="search-wrapper">
        <mat-icon class="search-icon">search</mat-icon>
        <input
          type="text"
          placeholder="Buscar por nombre, c茅dula o email..."
          [ngModel]="searchTerm()"
          (ngModelChange)="setSearch($event)"
        />
        @if (searchTerm()) {
          <button mat-icon-button (click)="setSearch('')" class="clear-btn">
            <mat-icon>close</mat-icon>
          </button>
        }
      </div>
    </div>
  </header>

  <div class="clients-wrapper">
    
    <div class="actions-bar">
      <button mat-flat-button class="btn-new" (click)="showCreateForm()">
        <mat-icon>person_add</mat-icon> NUEVO CLIENTE
      </button>
    </div>

    <div class="clients-grid">
      
      @if (loading()) {
        <div class="loading-state">
          <div class="spinner"></div>
          <p>Cargando agenda...</p>
        </div>

      } @else if (filteredClients().length === 0) {
        <div class="empty-state">
          <div class="icon-circle"><mat-icon>group_off</mat-icon></div>
          <h3>No se encontraron clientes</h3>
          <p>Intenta con otro nombre o registra uno nuevo.</p>
          <button mat-stroked-button color="primary" (click)="setSearch('')">Limpiar b煤squeda</button>
        </div>

      } @else {
        @for (c of filteredClients(); track c.id) {
          <div class="client-card elevation-z2" (click)="editClient(c)">
            
            <div class="card-left">
              <div class="avatar-circle" [style.background-color]="getColor(c.nombre)">
                {{ c.nombre.charAt(0).toUpperCase() }}
              </div>
            </div>

            <div class="card-center">
              <h3 class="name">{{ c.nombre }}</h3>
              
              <div class="details-row">
                @if(c.cedula) {
                  <span class="badge"><mat-icon>badge</mat-icon> {{ c.cedula }}</span>
                }
                @if(c.telefono) {
                  <span class="badge"><mat-icon>phone</mat-icon> {{ c.telefono }}</span>
                }
              </div>
              
              @if(c.email) {
                <span class="email-text">{{ c.email }}</span>
              }
            </div>

            <div class="card-right">
              <button mat-icon-button color="warn" class="delete-btn" 
                      (click)="deleteClient(c.id); $event.stopPropagation()"
                      matTooltip="Eliminar cliente">
                <mat-icon>delete_outline</mat-icon>
              </button>
              <mat-icon class="edit-icon">chevron_right</mat-icon>
            </div>

          </div>
        }
      }
    </div>
  </div>

  <ng-template #clientFormDialog>
    <div class="modern-dialog">
      
      <div class="dialog-header">
        <h2>{{ selectedClientId() ? 'Editar Cliente' : 'Nuevo Cliente' }}</h2>
        <button mat-icon-button mat-dialog-close class="close-btn"><mat-icon>close</mat-icon></button>
      </div>

      <div class="dialog-body">
        <p class="dialog-subtitle">Ingresa los datos para facturaci贸n y contacto.</p>

        @if (formError()) {
          <div class="error-box">
            <mat-icon>error</mat-icon> {{ formError() }}
          </div>
        }

        <div class="form-grid">
          
          <mat-form-field appearance="outline" class="col-full custom-field">
            <mat-label>Apellidos y Nombres (Raz贸n Social)</mat-label>
            <mat-icon matPrefix class="prefix-icon">person</mat-icon>
            <input matInput [ngModel]="form().nombre" (ngModelChange)="updateField('nombre', $event.toUpperCase())" required />
          </mat-form-field>

          <mat-form-field appearance="outline" class="col-half custom-field">
            <mat-label>C茅dula / RUC</mat-label>
            <mat-icon matPrefix class="prefix-icon">badge</mat-icon>
            <input matInput [ngModel]="form().cedula" (ngModelChange)="updateField('cedula', $event)" maxlength="13" />
          </mat-form-field>

          <mat-form-field appearance="outline" class="col-half custom-field">
            <mat-label>Tel茅fono</mat-label>
            <mat-icon matPrefix class="prefix-icon">phone</mat-icon>
            <input matInput type="tel" [ngModel]="form().telefono" (ngModelChange)="updateField('telefono', $event)" maxlength="10" />
          </mat-form-field>

          <mat-form-field appearance="outline" class="col-full custom-field">
            <mat-label>Correo Electr贸nico</mat-label>
            <mat-icon matPrefix class="prefix-icon">mail</mat-icon>
            <input matInput type="email" [ngModel]="form().email" (ngModelChange)="updateField('email', $event.toLowerCase())" />
          </mat-form-field>

          <mat-form-field appearance="outline" class="col-full custom-field">
            <mat-label>Direcci贸n</mat-label>
            <mat-icon matPrefix class="prefix-icon">place</mat-icon>
            <input matInput [ngModel]="form().direccion" (ngModelChange)="updateField('direccion', $event.toUpperCase())" />
          </mat-form-field>

        </div>
      </div>

      <div class="dialog-actions">
        <button mat-stroked-button mat-dialog-close (click)="cancelar()">Cancelar</button>
        <button mat-flat-button color="primary" class="save-btn" (click)="guardar()" [disabled]="!form().nombre">
          {{ selectedClientId() ? 'ACTUALIZAR' : 'GUARDAR' }}
        </button>
      </div>

    </div>
  </ng-template>

</div>