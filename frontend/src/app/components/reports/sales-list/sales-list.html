<div class="list-container fade-in">
    
    <mat-tab-group [(selectedIndex)]="innerTab" animationDuration="0ms">
        
        <mat-tab label="General">
            <div class="tab-content">
                
                <div class="filters-panel">
                    <div class="inputs-row">
                        <mat-form-field appearance="outline" class="dense-input">
                            <mat-label>Periodo</mat-label>
                            <mat-select [(ngModel)]="periodGeneral">
                                <mat-option value="today">Hoy</mat-option>
                                <mat-option value="week">Esta Semana</mat-option>
                                <mat-option value="month">Este Mes</mat-option>
                                <mat-option value="custom">Rango Personalizado</mat-option>
                            </mat-select>
                        </mat-form-field>

                        @if(periodGeneral() === 'custom') {
                            <mat-form-field appearance="outline" class="dense-input">
                                <mat-label>Desde</mat-label>
                                <input matInput type="date" [(ngModel)]="fromGeneral">
                            </mat-form-field>
                            <mat-form-field appearance="outline" class="dense-input">
                                <mat-label>Hasta</mat-label>
                                <input matInput type="date" [(ngModel)]="toGeneral">
                            </mat-form-field>
                        }

                        <button mat-flat-button color="primary" class="search-btn" (click)="loadGeneral()">
                            <mat-icon>search</mat-icon> Buscar
                        </button>
                    </div>
                </div>

                <div class="actions-bar" *ngIf="summaryGeneral().count > 0">
                    <div class="total-info">
                        <span class="label">{{ summaryGeneral().count }} ventas</span>
                        <span class="value">{{ summaryGeneral().total | currency }}</span>
                    </div>
                    <div class="buttons-group">
                        <button mat-stroked-button (click)="exportPDF()">
                            <mat-icon>picture_as_pdf</mat-icon> PDF
                        </button>
                        <button mat-flat-button class="btn-excel" (click)="exportExcel()">
                            <mat-icon>table_view</mat-icon> Excel
                        </button>
                    </div>
                </div>

                <div class="sales-grid">
                    <div *ngFor="let sale of salesGeneral()" class="sale-card" (click)="toggleDetalles(sale.id)">
                        
                        <div class="card-header">
                            <div class="avatar" [style.background-color]="getAvatarColor(sale.client_nombre)">
                                {{ getInitials(sale.client_nombre) }}
                            </div>
                            <div class="card-meta">
                                <span class="name">{{ sale.client_nombre || 'Consumidor Final' }}</span>
                                <span class="date">{{ formatearHora(sale.created_at) }}</span>
                            </div>
                            <div class="card-price">
                                <span class="price">{{ sale.total | currency }}</span>
                                <mat-icon>chevron_right</mat-icon>
                            </div>
                        </div>

                        <div class="card-details" *ngIf="selectedSaleId() === sale.id" (click)="$event.stopPropagation()">
                            <div *ngIf="loadingDetail()" class="loading-spinner">Cargando...</div>
                            
                            <table *ngIf="!loadingDetail() && saleDetails()[sale.id]" class="detail-table">
                                <tr *ngFor="let d of saleDetails()[sale.id]">
                                    <td class="prod-name">{{ d.nombre_producto }}</td>
                                    <td class="prod-qty">x{{ d.cantidad }}</td>
                                    <td class="prod-total">{{ d.subtotal | currency }}</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="no-data" *ngIf="salesGeneral().length === 0 && !loadingGeneral()">
                    <mat-icon>event_busy</mat-icon>
                    <p>No hay ventas en este rango.</p>
                </div>
            </div>
        </mat-tab>

        <mat-tab label="Por Cliente">
            <div class="tab-content">
                <div class="filters-panel">
                    <div class="inputs-row">
                        <mat-form-field appearance="outline" class="dense-input full-w-mobile">
                            <mat-label>Seleccionar Cliente</mat-label>
                            <mat-select [(ngModel)]="selectedClientId">
                                <mat-option *ngFor="let c of clients()" [value]="c.id">{{ c.nombre }}</mat-option>
                            </mat-select>
                        </mat-form-field>
                        <mat-form-field appearance="outline" class="dense-input">
                            <mat-label>Periodo</mat-label>
                            <mat-select [(ngModel)]="periodClient"><mat-option value="month">Este Mes</mat-option><mat-option value="year">Este Año</mat-option></mat-select>
                        </mat-form-field>
                        <button mat-flat-button color="primary" class="search-btn" (click)="loadByClient()"><mat-icon>search</mat-icon></button>
                    </div>
                </div>

                <div class="actions-bar" *ngIf="summaryClient().count > 0">
                    <div class="total-info">
                        <span class="label">Total Cliente</span>
                        <span class="value">{{ summaryClient().total | currency }}</span>
                    </div>
                    <div class="buttons-group">
                        <button mat-stroked-button (click)="exportPDF()">PDF</button>
                        <button mat-flat-button class="btn-excel" (click)="exportExcel()">Excel</button>
                    </div>
                </div>

                <div class="sales-grid">
                    <div *ngFor="let sale of salesClient()" class="sale-card" (click)="toggleDetalles(sale.id)">
                        <div class="card-header">
                            <div class="avatar" [style.background-color]="getAvatarColor(sale.client_nombre)">{{ getInitials(sale.client_nombre) }}</div>
                            <div class="card-meta">
                                <span class="name">{{ sale.created_at | date:'mediumDate' }}</span>
                                <span class="date">{{ sale.metodo_pago || 'Efectivo' }}</span>
                            </div>
                            <div class="card-price"><span class="price">{{ sale.total | currency }}</span></div>
                        </div>
                        <div class="card-details" *ngIf="selectedSaleId() === sale.id">
                             <table class="detail-table" *ngIf="saleDetails()[sale.id]">
                                <tr *ngFor="let d of saleDetails()[sale.id]">
                                    <td class="prod-name">{{ d.nombre_producto }}</td>
                                    <td class="prod-total">{{ d.subtotal | currency }}</td>
                                </tr>
                             </table>
                        </div>
                    </div>
                </div>
            </div>
        </mat-tab>

        <mat-tab label="Por Servicio">
            <div class="tab-content">
                <div class="filters-panel">
                    <div class="inputs-row">
                        <mat-form-field appearance="outline" class="dense-input full-w-mobile">
                            <mat-label>Servicio</mat-label>
                            <mat-select [(ngModel)]="selectedServiceId">
                                <mat-option *ngFor="let s of servicios()" [value]="s.id">{{ s.nombre }}</mat-option>
                            </mat-select>
                        </mat-form-field>
                        <mat-form-field appearance="outline" class="dense-input">
                            <mat-label>Periodo</mat-label>
                            <mat-select [(ngModel)]="periodService"><mat-option value="month">Este Mes</mat-option><mat-option value="year">Este Año</mat-option></mat-select>
                        </mat-form-field>
                        <button mat-flat-button color="primary" class="search-btn" (click)="loadByService()"><mat-icon>search</mat-icon></button>
                    </div>
                </div>
                <div class="actions-bar" *ngIf="summaryService().count > 0">
                    <div class="total-info">
                        <span class="label">Total Servicio</span>
                        <span class="value">{{ summaryService().total | currency }}</span>
                    </div>
                    <div class="buttons-group">
                        <button mat-stroked-button (click)="exportPDF()">PDF</button>
                        <button mat-flat-button class="btn-excel" (click)="exportExcel()">Excel</button>
                    </div>
                </div>
                <div class="sales-grid">
                    <div *ngFor="let sale of salesServiceList()" class="sale-card">
                        <div class="card-header">
                            <div class="card-meta">
                                <span class="name">{{ sale.client_nombre || 'Consumidor Final' }}</span>
                                <span class="date">{{ formatearHora(sale.created_at) }}</span>
                            </div>
                            <div class="card-price"><span class="price">{{ sale.total | currency }}</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </mat-tab>
    </mat-tab-group>
</div>