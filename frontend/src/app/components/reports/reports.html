<div class="reports-container">
  <div class="page-header">
    <div>
      <p class="eyebrow">Reportes</p>
      <h1>Resumen de ventas</h1>
      <p class="lead">Filtra, revisa y descarga los movimientos por periodo, cliente o servicio.</p>
    </div>
    <div class="actions-bar">
      <button mat-stroked-button color="primary" (click)="exportPDF()" [disabled]="!canExport()">
        <mat-icon>picture_as_pdf</mat-icon>
        Descargar PDF
      </button>
      <span class="hint" *ngIf="!canExport()">Aplica un filtro para habilitar la descarga</span>
    </div>
  </div>

  <div class="tabs">
    <button mat-button [class.active]="activeTab() === 'general'" (click)="activeTab.set('general')">
      <mat-icon>insights</mat-icon>
      General
    </button>
    <button mat-button [class.active]="activeTab() === 'client'" (click)="activeTab.set('client')">
      <mat-icon>person</mat-icon>
      Cliente
    </button>
    <button mat-button [class.active]="activeTab() === 'service'" (click)="activeTab.set('service')">
      <mat-icon>build</mat-icon>
      Servicio
    </button>
  </div>

  @if (activeTab() === 'general') {
  <mat-card class="panel">
    <div class="panel-header">
      <div>
        <div class="title">Ventas generales</div>
        <div class="subtitle">Semana, mes, año o rango personalizado</div>
        <div class="pill">{{ rangeLabel('General', periodGeneral(), fromGeneral(), toGeneral()) }}</div>
      </div>
      <div class="filters-row">
        <mat-form-field appearance="outline" class="period">
          <mat-label>Periodo</mat-label>
          <mat-select [ngModel]="periodGeneral()" (ngModelChange)="periodGeneral.set($event)">
            <mat-option value="today">Hoy</mat-option>
            <mat-option value="week">Semana</mat-option>
            <mat-option value="month">Mes</mat-option>
            <mat-option value="year">Año</mat-option>
            <mat-option value="custom">Personalizado</mat-option>
          </mat-select>
        </mat-form-field>
        @if (periodGeneral() === 'custom') {
        <mat-form-field appearance="outline">
          <mat-label>Desde</mat-label>
          <input matInput type="date" [ngModel]="fromGeneral()" (ngModelChange)="fromGeneral.set($event)" />
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>Hasta</mat-label>
          <input matInput type="date" [ngModel]="toGeneral()" (ngModelChange)="toGeneral.set($event)" />
        </mat-form-field>
        }
        <button mat-flat-button color="primary" (click)="loadGeneral()">Aplicar</button>
      </div>
    </div>

    <div class="sales-list" *ngIf="!loadingGeneral(); else loadingTpl">
      <div *ngIf="salesGeneral().length === 0" class="empty">Sin ventas en el periodo.</div>

      <mat-card class="sale" *ngFor="let sale of salesGeneral()" (click)="toggleDetalles(sale.id)">
        <div class="sale-header">
          <div>
            <div class="time">{{ formatearHora(sale.created_at) }}</div>
            <div class="chips">
              <span class="chip">{{ sale.client_nombre || 'Consumidor final' }}</span>
              <span class="chip muted">{{ sale.metodo_pago || 'Método N/D' }}</span>
              <span class="chip muted">ID: {{ sale.id.slice(0,8) }}...</span>
            </div>
          </div>
          
          <div class="money-col">
            <ng-container *ngIf="getValues(sale.total, 'inclusive', sale.tax_rate) as val">
              <div class="money-row small">
                <span>Sub:</span> <span>${{ val.subtotal | number:'1.2-2' }}</span>
              </div>
              <div class="money-row small">
                <span>IVA:</span> <span>${{ val.iva | number:'1.2-2' }}</span>
              </div>
              <div class="money-row total">
                ${{ val.total | number:'1.2-2' }}
              </div>
            </ng-container>
          </div>
        </div>

        @if (selectedSaleId() === sale.id) {
        <div class="details">
          <div class="details-header">Detalle de venta</div>
          @if (loadingDetail()) {
          <p class="loading">Cargando detalle...</p>
          } @else {
          @if ((saleDetails()[sale.id] || []).length === 0) {
          <p class="empty">Sin detalles.</p>
          } @else {
          <div class="detail-row detail-head">
            <div style="flex: 2;">Concepto</div>
            <div class="text-center">Cant.</div>
            <div class="text-right">P.Unit</div>
            <div class="text-right">Sub</div>
            <div class="text-right">IVA</div>
            <div class="text-right">Total</div>
          </div>
          <div class="detail-row" *ngFor="let d of saleDetails()[sale.id]">
            <div class="name" style="flex: 2;">{{ d.nombre_producto }}</div>
            <div class="text-center">x{{ d.cantidad }}</div>
            <div class="text-right">${{ d.precio_unitario | number:'1.2-2' }}</div>
            
            <ng-container *ngIf="getValues(d.subtotal, 'additive', sale.tax_rate) as val">
                <div class="text-right muted">${{ val.subtotal | number:'1.2-2' }}</div>
                <div class="text-right muted">${{ val.iva | number:'1.2-2' }}</div>
                <div class="text-right bold">${{ val.total | number:'1.2-2' }}</div>
            </ng-container>
          </div>
          }
          }
        </div>
        }
      </mat-card>
    </div>
  </mat-card>
  }

  @if (activeTab() === 'client') {
  <mat-card class="panel">
    <div class="panel-header">
      <div>
        <div class="title">Por cliente</div>
        <div class="subtitle">Historial por persona</div>
        <div class="pill">{{ rangeLabel('Cliente', periodClient(), fromClient(), toClient()) }}</div>
      </div>
      <div class="filters-row">
        <mat-form-field appearance="outline" class="full">
          <mat-label>Cliente</mat-label>
          <mat-select [ngModel]="selectedClientId()" (ngModelChange)="selectedClientId.set($event)">
            <mat-option value="">Selecciona cliente</mat-option>
            <mat-option *ngFor="let c of clients()" [value]="c.id">{{ c.nombre }}{{ c.cedula ? ' · ' + c.cedula : ''
              }}</mat-option>
          </mat-select>
        </mat-form-field>
        <mat-form-field appearance="outline" class="period">
          <mat-label>Periodo</mat-label>
          <mat-select [ngModel]="periodClient()" (ngModelChange)="periodClient.set($event)">
            <mat-option value="today">Hoy</mat-option>
            <mat-option value="week">Semana</mat-option>
            <mat-option value="month">Mes</mat-option>
            <mat-option value="year">Año</mat-option>
            <mat-option value="custom">Personalizado</mat-option>
          </mat-select>
        </mat-form-field>
        @if (periodClient() === 'custom') {
        <mat-form-field appearance="outline">
          <mat-label>Desde</mat-label>
          <input matInput type="date" [ngModel]="fromClient()" (ngModelChange)="fromClient.set($event)" />
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>Hasta</mat-label>
          <input matInput type="date" [ngModel]="toClient()" (ngModelChange)="toClient.set($event)" />
        </mat-form-field>
        }
        <button mat-flat-button color="primary" (click)="loadByClient()" [disabled]="!selectedClientId()">Aplicar</button>
      </div>
    </div>

    <div class="sales-list" *ngIf="!loadingClient(); else loadingTpl">
      <div *ngIf="salesClient().length === 0" class="empty">Sin ventas para este cliente.</div>

      <mat-card class="sale" *ngFor="let sale of salesClient()" (click)="toggleDetalles(sale.id)">
        <div class="sale-header">
          <div>
            <div class="time">{{ formatearHora(sale.created_at) }}</div>
            <div class="chips">
              <span class="chip">{{ sale.client_nombre || 'Consumidor final' }}</span>
              <span class="chip muted">{{ sale.metodo_pago || 'Método N/D' }}</span>
              <span class="chip muted">ID: {{ sale.id.slice(0,8) }}...</span>
            </div>
          </div>
          
          <div class="money-col">
            <ng-container *ngIf="getValues(sale.total, 'inclusive', sale.tax_rate) as val">
              <div class="money-row small">
                <span>Sub:</span> <span>${{ val.subtotal | number:'1.2-2' }}</span>
              </div>
              <div class="money-row small">
                <span>IVA:</span> <span>${{ val.iva | number:'1.2-2' }}</span>
              </div>
              <div class="money-row total">
                ${{ val.total | number:'1.2-2' }}
              </div>
            </ng-container>
          </div>
        </div>

        @if (selectedSaleId() === sale.id) {
        <div class="details">
          <div class="details-header">Detalle de venta</div>
          @if (loadingDetail()) {
          <p class="loading">Cargando detalle...</p>
          } @else {
          @if ((saleDetails()[sale.id] || []).length === 0) {
          <p class="empty">Sin detalles.</p>
          } @else {
          <div class="detail-row detail-head">
            <div style="flex: 2;">Concepto</div>
            <div class="text-center">Cant.</div>
            <div class="text-right">P.Unit</div>
            <div class="text-right">Sub</div>
            <div class="text-right">IVA</div>
            <div class="text-right">Total</div>
          </div>
          <div class="detail-row" *ngFor="let d of saleDetails()[sale.id]">
            <div class="name" style="flex: 2;">{{ d.nombre_producto }}</div>
            <div class="text-center">x{{ d.cantidad }}</div>
            <div class="text-right">${{ d.precio_unitario | number:'1.2-2' }}</div>
            
            <ng-container *ngIf="getValues(d.subtotal, 'additive', sale.tax_rate) as val">
                <div class="text-right muted">${{ val.subtotal | number:'1.2-2' }}</div>
                <div class="text-right muted">${{ val.iva | number:'1.2-2' }}</div>
                <div class="text-right bold">${{ val.total | number:'1.2-2' }}</div>
            </ng-container>
          </div>
          }
          }
        </div>
        }
      </mat-card>
    </div>
  </mat-card>
  }

  @if (activeTab() === 'service') {
  <mat-card class="panel">
    <div class="panel-header">
      <div>
        <div class="title">Por servicio</div>
        <div class="subtitle">Filtra un servicio específico</div>
        <div class="pill">{{ rangeLabel('Servicio', periodService(), fromService(), toService()) }}</div>
      </div>
      <div class="filters-row">
        <mat-form-field appearance="outline" class="full">
          <mat-label>Servicio</mat-label>
          <mat-select [ngModel]="selectedServiceId()" (ngModelChange)="selectedServiceId.set($event)">
            <mat-option value="">Selecciona servicio</mat-option>
            <mat-option *ngFor="let s of servicios()" [value]="s.id">{{ s.nombre }}</mat-option>
          </mat-select>
        </mat-form-field>
        <mat-form-field appearance="outline" class="period">
          <mat-label>Periodo</mat-label>
          <mat-select [ngModel]="periodService()" (ngModelChange)="periodService.set($event)">
            <mat-option value="today">Hoy</mat-option>
            <mat-option value="week">Semana</mat-option>
            <mat-option value="month">Mes</mat-option>
            <mat-option value="year">Año</mat-option>
            <mat-option value="custom">Personalizado</mat-option>
          </mat-select>
        </mat-form-field>
        @if (periodService() === 'custom') {
        <mat-form-field appearance="outline">
          <mat-label>Desde</mat-label>
          <input matInput type="date" [ngModel]="fromService()" (ngModelChange)="fromService.set($event)" />
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>Hasta</mat-label>
          <input matInput type="date" [ngModel]="toService()" (ngModelChange)="toService.set($event)" />
        </mat-form-field>
        }
        <button mat-flat-button color="primary" (click)="loadByService()" [disabled]="!selectedServiceId()">Aplicar</button>
      </div>
    </div>

    <div class="sales-list" *ngIf="!loadingService(); else loadingTpl">
      <div *ngIf="salesServiceList().length === 0" class="empty">Sin ventas para este servicio.</div>

      <mat-card class="sale" *ngFor="let sale of salesServiceList()" (click)="toggleDetalles(sale.id)">
        <div class="sale-header">
          <div>
            <div class="time">{{ formatearHora(sale.created_at) }}</div>
            <div class="chips">
              <span class="chip">{{ sale.client_nombre || 'Consumidor final' }}</span>
              <span class="chip muted">{{ sale.metodo_pago || 'Método N/D' }}</span>
              <span class="chip muted">ID: {{ sale.id.slice(0,8) }}...</span>
            </div>
          </div>
          
          <div class="money-col">
            <ng-container *ngIf="getValues(sale.total, 'additive', sale.tax_rate) as val">
              <div class="money-row small">
                <span>Sub:</span> <span>${{ val.subtotal | number:'1.2-2' }}</span>
              </div>
              <div class="money-row small">
                <span>IVA:</span> <span>${{ val.iva | number:'1.2-2' }}</span>
              </div>
              <div class="money-row total">
                ${{ val.total | number:'1.2-2' }}
              </div>
            </ng-container>
          </div>
        </div>

        @if (selectedSaleId() === sale.id) {
        <div class="details">
          <div class="details-header">Detalle de venta</div>
          @if (loadingDetail()) {
          <p class="loading">Cargando detalle...</p>
          } @else {
          @if ((saleDetails()[sale.id] || []).length === 0) {
          <p class="empty">Sin detalles.</p>
          } @else {
          <div class="detail-row detail-head">
            <div style="flex: 2;">Concepto</div>
            <div class="text-center">Cant.</div>
            <div class="text-right">P.Unit</div>
            <div class="text-right">Sub</div>
            <div class="text-right">IVA</div>
            <div class="text-right">Total</div>
          </div>
          <div class="detail-row" *ngFor="let d of saleDetails()[sale.id]">
            <div class="name" style="flex: 2;">{{ d.nombre_producto }}</div>
            <div class="text-center">x{{ d.cantidad }}</div>
            <div class="text-right">${{ d.precio_unitario | number:'1.2-2' }}</div>
            
            <ng-container *ngIf="getValues(d.subtotal, 'additive', sale.tax_rate) as val">
                <div class="text-right muted">${{ val.subtotal | number:'1.2-2' }}</div>
                <div class="text-right muted">${{ val.iva | number:'1.2-2' }}</div>
                <div class="text-right bold">${{ val.total | number:'1.2-2' }}</div>
            </ng-container>
          </div>
          }
          }
        </div>
        }
      </mat-card>
    </div>
  </mat-card>
  }

  <ng-template #loadingTpl>
    <p class="loading">Cargando...</p>
  </ng-template>
</div>