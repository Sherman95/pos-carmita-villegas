<div class="page-container">
  
  <header class="header-section">
    <div class="header-content">
      <h1>Reportes ðŸ“Š</h1>
      <p>Resumen y descarga de movimientos</p>

      <div class="actions-bar">
        @if (canExport()) {
          <button mat-flat-button class="btn-pdf" (click)="exportPDF()">
            <mat-icon>picture_as_pdf</mat-icon> Descargar PDF
          </button>
        } @else {
          <div class="hint-pill">
            <mat-icon>info</mat-icon> Aplica un filtro para descargar
          </div>
        }
      </div>
    </div>

    <div class="tabs-container">
      <button class="tab-btn" [class.active]="activeTab() === 'general'" (click)="activeTab.set('general')">
        <mat-icon>insights</mat-icon> General
      </button>
      <button class="tab-btn" [class.active]="activeTab() === 'client'" (click)="activeTab.set('client')">
        <mat-icon>person</mat-icon> Cliente
      </button>
      <button class="tab-btn" [class.active]="activeTab() === 'service'" (click)="activeTab.set('service')">
        <mat-icon>build</mat-icon> Servicio
      </button>
    </div>
  </header>

  <div class="content-container">

    @if (activeTab() === 'general') {
      <mat-card class="filter-panel elevation-z2">
        <div class="panel-header">
          <div class="titles">
            <h3>Ventas Generales</h3>
            <span class="pill-range">{{ rangeLabel('General', periodGeneral(), fromGeneral(), toGeneral()) }}</span>
          </div>
          
          <div class="filters-grid">
            <mat-form-field appearance="outline" class="dense">
              <mat-label>Periodo</mat-label>
              <mat-select [ngModel]="periodGeneral()" (ngModelChange)="periodGeneral.set($event)">
                <mat-option value="today">Hoy</mat-option>
                <mat-option value="week">Semana</mat-option>
                <mat-option value="month">Mes</mat-option>
                <mat-option value="year">AÃ±o</mat-option>
                <mat-option value="custom">Personalizado</mat-option>
              </mat-select>
            </mat-form-field>

            @if (periodGeneral() === 'custom') {
              <mat-form-field appearance="outline" class="dense">
                <mat-label>Desde</mat-label>
                <input matInput type="date" [ngModel]="fromGeneral()" (ngModelChange)="fromGeneral.set($event)" />
              </mat-form-field>
              <mat-form-field appearance="outline" class="dense">
                <mat-label>Hasta</mat-label>
                <input matInput type="date" [ngModel]="toGeneral()" (ngModelChange)="toGeneral.set($event)" />
              </mat-form-field>
            }
            
            <button mat-flat-button color="primary" (click)="loadGeneral()">Aplicar</button>
          </div>
        </div>

        <div class="sales-list-wrapper">
          @if (loadingGeneral()) {
            <p class="loading">Cargando...</p>
          } @else if (salesGeneral().length === 0) {
            <div class="empty-state">Sin ventas en el periodo.</div>
          } @else {
            @for (sale of salesGeneral(); track sale.id) {
              <div class="sale-card" (click)="toggleDetalles(sale.id)">
                <div class="card-main">
                  <div class="info-block">
                    <span class="time">{{ formatearHora(sale.created_at) }}</span>
                    <span class="client">{{ sale.client_nombre || 'Consumidor final' }}</span>
                    <div class="meta">
                      <span class="badge">{{ sale.metodo_pago || 'N/D' }}</span>
                      <span class="id">ID: {{ sale.id.slice(0,8) }}</span>
                    </div>
                  </div>
                  
                  <div class="money-block">
                    <ng-container *ngIf="getValues(sale.total, 'inclusive', sale.tax_rate) as val">
                      <div class="row-small"><span>Sub:</span> ${{ val.subtotal | number:'1.2-2' }}</div>
                      <div class="row-small"><span>IVA:</span> ${{ val.iva | number:'1.2-2' }}</div>
                      <div class="row-total">${{ val.total | number:'1.2-2' }}</div>
                    </ng-container>
                  </div>
                </div>

                @if (selectedSaleId() === sale.id) {
                  <div class="card-details">
                    <div class="detail-header">Detalle de la venta</div>
                    @if (loadingDetail()) {
                      <p class="loading-sm">Cargando...</p>
                    } @else {
                      @for (d of saleDetails()[sale.id]; track d.id) {
                         <div class="detail-item">
                           <div class="prod-name">{{ d.nombre_producto }} <small>x{{ d.cantidad }}</small></div>
                           <div class="prod-price">${{ d.subtotal | number:'1.2-2' }}</div>
                         </div>
                      }
                    }
                  </div>
                }
              </div>
            }
          }
        </div>
      </mat-card>
    }

    @if (activeTab() === 'client') {
      <mat-card class="filter-panel elevation-z2">
        <div class="panel-header">
          <div class="titles">
            <h3>Por Cliente</h3>
            <span class="pill-range">{{ rangeLabel('Cliente', periodClient(), fromClient(), toClient()) }}</span>
          </div>

          <div class="filters-grid">
            
            <mat-form-field appearance="outline" class="dense full-w">
              <mat-label>Seleccionar Cliente</mat-label>
              <mat-select [ngModel]="selectedClientId()" 
                          (ngModelChange)="selectedClientId.set($event)" 
                          panelClass="custom-client-panel"> <mat-option value="">-- Seleccione --</mat-option>
                
                <mat-option *ngFor="let c of clients()" [value]="c.id" class="client-option-row">
                   <div class="option-flex">
                      <div class="avatar-mini">
                        {{ c.nombre.charAt(0).toUpperCase() }}
                      </div>
                      <div class="text-group">
                        <span class="name">{{ c.nombre }}</span>
                        <small class="cedula" *ngIf="c.cedula">CI: {{ c.cedula }}</small>
                      </div>
                   </div>
                </mat-option>

              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline" class="dense">
              <mat-label>Periodo</mat-label>
              <mat-select [ngModel]="periodClient()" (ngModelChange)="periodClient.set($event)">
                <mat-option value="today">Hoy</mat-option>
                <mat-option value="week">Semana</mat-option>
                <mat-option value="month">Mes</mat-option>
                <mat-option value="year">AÃ±o</mat-option>
                <mat-option value="custom">Personalizado</mat-option>
              </mat-select>
            </mat-form-field>

            @if (periodClient() === 'custom') {
              <mat-form-field appearance="outline" class="dense">
                <mat-label>Desde</mat-label>
                <input matInput type="date" [ngModel]="fromClient()" (ngModelChange)="fromClient.set($event)" />
              </mat-form-field>
              <mat-form-field appearance="outline" class="dense">
                <mat-label>Hasta</mat-label>
                <input matInput type="date" [ngModel]="toClient()" (ngModelChange)="toClient.set($event)" />
              </mat-form-field>
            }
            <button mat-flat-button color="primary" (click)="loadByClient()" [disabled]="!selectedClientId()">Aplicar</button>
          </div>
        </div>

        <div class="sales-list-wrapper">
          @if (loadingClient()) {
            <p class="loading">Cargando...</p>
          } @else if (salesClient().length === 0) {
            <div class="empty-state">Sin ventas para este cliente.</div>
          } @else {
            @for (sale of salesClient(); track sale.id) {
               <div class="sale-card" (click)="toggleDetalles(sale.id)">
                <div class="card-main">
                  <div class="info-block">
                    <span class="time">{{ formatearHora(sale.created_at) }}</span>
                    <span class="client">{{ sale.client_nombre || 'Consumidor' }}</span>
                    <div class="meta">
                      <span class="badge">{{ sale.metodo_pago }}</span>
                    </div>
                  </div>
                  <div class="money-block">
                    <ng-container *ngIf="getValues(sale.total, 'inclusive', sale.tax_rate) as val">
                      <div class="row-total">${{ val.total | number:'1.2-2' }}</div>
                    </ng-container>
                  </div>
                </div>

                @if (selectedSaleId() === sale.id) {
                  <div class="card-details">
                    <div class="detail-header">Detalle</div>
                    @if (loadingDetail()) { <p class="loading-sm">...</p> } 
                    @else {
                      @for (d of saleDetails()[sale.id]; track d.id) {
                         <div class="detail-item">
                           <div class="prod-name">{{ d.nombre_producto }} x{{ d.cantidad }}</div>
                           <div class="prod-price">${{ d.subtotal | number:'1.2-2' }}</div>
                         </div>
                      }
                    }
                  </div>
                }
               </div>
            }
          }
        </div>
      </mat-card>
    }

    @if (activeTab() === 'service') {
      <mat-card class="filter-panel elevation-z2">
        <div class="panel-header">
          <div class="titles">
             <h3>Por Servicio</h3>
             <span class="pill-range">{{ rangeLabel('Servicio', periodService(), fromService(), toService()) }}</span>
          </div>

          <div class="filters-grid">
            <mat-form-field appearance="outline" class="dense full-w">
              <mat-label>Seleccionar Servicio</mat-label>
              <mat-select [ngModel]="selectedServiceId()" (ngModelChange)="selectedServiceId.set($event)">
                <mat-option value="">-- Seleccione --</mat-option>
                <mat-option *ngFor="let s of servicios()" [value]="s.id">{{ s.nombre }}</mat-option>
              </mat-select>
            </mat-form-field>
            
            <mat-form-field appearance="outline" class="dense">
              <mat-label>Periodo</mat-label>
              <mat-select [ngModel]="periodService()" (ngModelChange)="periodService.set($event)">
                 <mat-option value="today">Hoy</mat-option>
                 <mat-option value="week">Semana</mat-option>
                 <mat-option value="month">Mes</mat-option>
                 <mat-option value="year">AÃ±o</mat-option>
                 <mat-option value="custom">Pers.</mat-option>
              </mat-select>
            </mat-form-field>

             @if (periodService() === 'custom') {
              <mat-form-field appearance="outline" class="dense">
                <mat-label>Desde</mat-label>
                <input matInput type="date" [ngModel]="fromService()" (ngModelChange)="fromService.set($event)" />
              </mat-form-field>
              <mat-form-field appearance="outline" class="dense">
                <mat-label>Hasta</mat-label>
                <input matInput type="date" [ngModel]="toService()" (ngModelChange)="toService.set($event)" />
              </mat-form-field>
            }
            <button mat-flat-button color="primary" (click)="loadByService()" [disabled]="!selectedServiceId()">Aplicar</button>
          </div>
        </div>

        <div class="sales-list-wrapper">
          @if (loadingService()) {
             <p class="loading">Cargando...</p>
          } @else if (salesServiceList().length === 0) {
             <div class="empty-state">Sin ventas para este servicio.</div>
          } @else {
             @for (sale of salesServiceList(); track sale.id) {
               <div class="sale-card" (click)="toggleDetalles(sale.id)">
                 <div class="card-main">
                    <div class="info-block">
                      <span class="time">{{ formatearHora(sale.created_at) }}</span>
                      <span class="client">{{ sale.client_nombre }}</span>
                    </div>
                    <div class="money-block">
                       <ng-container *ngIf="getValues(sale.total, 'additive', sale.tax_rate) as val">
                          <div class="row-total">${{ val.total | number:'1.2-2' }}</div>
                       </ng-container>
                    </div>
                 </div>
                  @if (selectedSaleId() === sale.id) {
                    <div class="card-details">
                      @for (d of saleDetails()[sale.id]; track d.id) {
                         <div class="detail-item">
                           <div class="prod-name">{{ d.nombre_producto }} x{{ d.cantidad }}</div>
                           <div class="prod-price">${{ d.subtotal | number:'1.2-2' }}</div>
                         </div>
                      }
                    </div>
                  }
               </div>
             }
          }
        </div>
      </mat-card>
    }

  </div>
</div>